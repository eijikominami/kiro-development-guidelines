# 品質保証ガイドライン

## コミット前品質保証メカニズム（必須）

### Pre-commit フックによる自動化（推奨）

**重要**: pre-commit フックを使用することで、コミット前の品質チェックを自動化できる

#### Pre-commit のセットアップ

##### 1. 開発依存関係のインストール
```bash
# プロジェクトの開発依存関係をインストール
# 例: pip install -e ".[dev]", npm install --save-dev, など
```

##### 2. Pre-commit フックのインストール
```bash
# プロジェクトルートで実行
pre-commit install
```

##### 3. 設定ファイルの作成（.pre-commit-config.yaml）

プロジェクトに応じて以下を設定:
- コードフォーマッター（自動修正）
- Lint チェック（エラー検出）
- 型チェック（オプション）
- セキュリティチェック（オプション）
- 基本的なチェック（末尾空白、EOF、YAML/JSON構文など）

##### 4. 手動実行（オプション）
```bash
# 全ファイルに対して実行
pre-commit run --all-files

# 特定のフックのみ実行
pre-commit run [hook-name] --all-files
```

#### Pre-commit の利点
- **自動実行**: git commit 時に自動的にチェックが実行される
- **問題の早期発見**: コミット前に問題を検出できる
- **一貫性**: チーム全体で同じ品質基準を適用できる
- **CI/CD の負荷軽減**: ローカルで問題を解決してからプッシュできる

### リリース前の確認

**重要**: 自動テストだけでは検出できない問題があるため、リリース前に確認を実施する

#### Kiro が実施する確認項目

1. **コード品質確認**
   - コードフォーマットの適用状況
   - Lint エラーの有無
   - 型チェックの結果
   - テストカバレッジ

2. **ドキュメント確認**
   - README の手順が最新か
   - コード例が動作するか
   - リンクが有効か
   - バージョン番号の整合性

3. **設定ファイル確認**
   - 構文エラーの有無
   - 依存関係の整合性
   - 環境変数の定義

4. **ログ・エラー確認**
   - ログファイルの解析
   - エラーメッセージの確認
   - スタックトレースの分析

#### 人間が実施する確認項目

1. **実際の動作確認**
   - アプリケーション/ツールの起動
   - 主要機能の動作確認
   - ユーザー体験の評価

2. **視覚的な確認（UI がある場合）**
   - UI 要素の表示確認
   - レイアウトの確認
   - デザインの妥当性

3. **ビジネスロジック確認**
   - 要件を満たしているか
   - エッジケースの動作
   - セキュリティ上の懸念

#### 確認のタイミング

- ✅ **プルリクエスト作成前**: feature ブランチで実装完了後（Kiro + 人間）
- ✅ **main マージ前**: レビュー完了後（Kiro + 人間）
- ✅ **リリース前**: タグプッシュ前に最終確認（Kiro + 人間）

### Pre-commit と CI/CD の連携ガイドライン（必須）

**重要原則**: CI/CD で実行される品質チェックは、可能な限り pre-commit でもローカル実行できるようにする

#### 1. CI/CD チェック項目の Pre-commit 対応

##### 対応すべき項目
- ✅ **コードフォーマット**: 自動フォーマッター → pre-commit で自動修正
- ✅ **Lint チェック**: → pre-commit で検出
- ✅ **型チェック**: → pre-commit で検出可能
- ✅ **セキュリティチェック**: → pre-commit で検出可能
- ✅ **基本検証**: 末尾空白、EOF、構文チェック → pre-commit で自動修正
- ⚠️ **単体テスト**: → pre-commit で実行可能だが重い場合は CI のみ
- ⚠️ **統合テスト**: → 通常は CI のみ（環境依存のため）
- ⚠️ **ビルドテスト**: パッケージインストール等 → CI のみ

#### 2. CI/CD と Pre-commit の役割分担

##### Pre-commit で実行すべきもの
- **高速なチェック**: 数秒以内に完了するもの
- **自動修正可能**: フォーマッター等の自動修正ツール
- **開発体験向上**: 即座にフィードバックが得られるもの
- **必須品質基準**: コミット前に必ず満たすべき基準

##### CI/CD でのみ実行すべきもの
- **時間のかかるテスト**: 統合テスト、E2E テスト
- **環境依存のテスト**: パッケージインストール、Docker ビルド
- **複数環境テスト**: 複数のバージョン、OS
- **デプロイ関連**: リリース作成、パッケージ公開

#### 3. 段階的な品質チェック戦略

```
開発者ローカル環境
├── Pre-commit フック（必須）
│   ├── コードフォーマット（自動修正）
│   ├── Lint チェック（エラー検出）
│   └── 基本検証（自動修正）
│
├── 手動テスト（推奨）
│   ├── 単体テスト実行
│   └── 基本機能確認
│
└── Git Push
    ↓
CI/CD パイプライン
├── Pull Request 時
│   ├── 全品質チェック再実行
│   ├── 単体テスト + 統合テスト
│   ├── 複数環境テスト
│   └── パッケージインストールテスト
│
└── Tag Push 時（リリース）
    ├── 全テスト実行
    ├── ビルド + パッケージ作成
    └── リリース作成
```

#### 4. Pre-commit スキップのガイドライン

##### スキップが許容される場合
- **緊急修正**: ホットフィックスで即座のコミットが必要
- **ドキュメントのみ変更**: コードに影響しない変更
- **WIP コミット**: 作業中の一時保存（後で修正前提）

##### スキップ時の注意事項
- **CI で必ず確認**: スキップしても CI でチェックされることを確認
- **後で修正**: WIP コミットは後で必ず修正してから PR 作成
- **記録**: コミットメッセージにスキップ理由を記載

#### 5. チーム開発での運用ルール

##### 必須ルール
1. **Pre-commit インストール必須**: 全開発者が `pre-commit install` を実行
2. **CI 失敗時の対応**: CI で失敗したら必ずローカルで再現・修正
3. **Pre-commit 更新**: `.pre-commit-config.yaml` 更新時は `pre-commit autoupdate` 実行

##### 推奨ルール
1. **定期的な更新**: 月1回程度 pre-commit フックのバージョンを更新
2. **新規フック追加**: チーム合意の上で段階的に追加
3. **パフォーマンス監視**: Pre-commit が遅い場合は設定を見直し

#### 6. トラブルシューティング

##### Pre-commit が遅い場合
```bash
# 特定のフックのみ実行
pre-commit run [hook-name] --all-files

# 変更ファイルのみチェック
git add -A
pre-commit run

# キャッシュクリア
pre-commit clean
```

##### Pre-commit が失敗する場合
```bash
# 詳細ログ表示
pre-commit run --verbose --all-files

# 環境再構築
pre-commit clean
pre-commit install --install-hooks
```

##### CI と Pre-commit の結果が異なる場合
```bash
# CI と同じ環境で実行
pre-commit run --all-files --show-diff-on-failure

# Pre-commit 設定の更新
pre-commit autoupdate
```

### コミット前の必須検証プロセス

**重要**: Pre-commit フックを使用しない場合は、以下の検証を手動で実行する

#### 1. ローカル統合テスト（必須）

以下を実行:
1. コードフォーマット（必須）
2. Lint チェック（必須）
3. 型チェック（該当する場合）
4. 依存関係の確認
5. 基本機能テスト
6. ユニットテスト実行

#### 2. 環境別テスト（推奨）

##### 仮想環境でのテスト
クリーンな環境でのインストール・動作確認を実施

##### コンテナでのテスト（可能な場合）
Docker 等を使用したクリーンな環境でのテスト

#### 3. 依存関係検証（必須）

- 依存関係の整合性確認
- 依存関係の脆弱性チェック
- 外部サービス依存の確認

#### 4. 設定ファイル・ドキュメント検証（必須）

- 設定ファイルの構文チェック（JSON, YAML, TOML, XML など）
- ドキュメントの整合性確認
- リンクの有効性確認
- スペルチェック

## 段階的リリース戦略

### Pre-release での検証
プレリリース版を作成して検証を行い、問題なければ正式リリースを実施する。

### リリースプロセス
1. 機能ブランチでの完全テスト
2. main ブランチへのマージ
3. main ブランチでの最終確認
4. バージョンタグの作成とリリース

詳細なブランチ戦略は `development-guidelines.md` を参照。

## 自動化による品質保証

### Pre-commit フックの設定

#### Pre-commit のインストールと有効化
```bash
# pre-commit のインストール
pip install pre-commit

# プロジェクトに pre-commit フックを設定
pre-commit install

# 全ファイルに対して手動実行（初回）
pre-commit run --all-files

# 以降、git commit 時に自動実行される
```

### CI/CD での段階的検証

CI/CD パイプラインで以下を実施:
1. コードフォーマット・Lint チェック
2. 単体テスト実行
3. 統合テスト実行
4. ビルド処理
5. リリース作成（タグプッシュ時）

## 問題発生時の迅速対応メカニズム

### ロールバック戦略
```bash
# 1. 問題のあるリリースの特定
git log --oneline

# 2. 前のバージョンへのロールバック
git revert [problematic_commit]
git tag v1.x.x-hotfix.1
```

### ホットフィックス手順
```bash
# 1. ホットフィックスブランチの作成
git checkout -b hotfix/v1.x.x-fix

# 2. 最小限の修正
[minimal_fix]

# 3. 緊急テスト
[critical_tests_only]

# 4. 緊急リリース
git tag v1.x.x-hotfix.1
```

## 検証チェックリスト

### コミット前必須チェック項目
- [ ] コードフォーマット実行完了
- [ ] Lint チェック完了
- [ ] ローカルでの基本機能テスト完了
- [ ] 依存関係の完全性確認完了
- [ ] 設定ファイルの構文チェック完了
- [ ] ドキュメントの整合性確認完了
- [ ] 重要な使用ケースのテスト完了

### リリース前必須チェック項目
- [ ] クリーン環境でのインストールテスト完了
- [ ] 全機能の動作確認完了
- [ ] アンインストールテスト完了
- [ ] ドキュメントの手順確認完了
- [ ] CI/CD の動作確認完了

### 緊急時対応チェック項目
- [ ] 問題の影響範囲特定完了
- [ ] ロールバック手順確認完了
- [ ] ユーザーへの通知準備完了
- [ ] 修正版のテスト完了

## 継続的改善

### 問題パターンの記録と対策

プロジェクト固有の問題を記録し、再発防止策を文書化する。

```markdown
## 品質問題記録

### 問題: [問題の簡潔な説明]
- **発生日**: YYYY-MM-DD
- **原因**: [根本原因]
- **対策**: [実施した対策]
- **予防策**: [再発防止のための仕組み]
```
